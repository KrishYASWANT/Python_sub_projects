from django.conf import settings
from django.shortcuts import render, redirect
from django.contrib import messages
from django.core.mail import send_mail
from .forms import CreatorSignupForm
from .models import CreatorUser
from .utils import generate_verification_token

def creator_signup(request):
    if request.method == 'POST':
        form = CreatorSignupForm(request.POST)
        if form.is_valid():
            user = form.save(commit=False)
            user.is_creator = True
            user.is_active = False  # deactivate until verified
            user.save()

            token = generate_verification_token(user.email)
            verification_link = request.build_absolute_uri(f'/creators/verify-email/{token}/')
            
            send_mail(
                subject='Verify your Creator account',
                message=f'Click the link to verify your email: {verification_link}',
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=[user.email]
            )

            messages.success(request, 'Check your email to verify your creator account.')
            return redirect('login')
    else:
        form = CreatorSignupForm()
    
    return render(request, 'creators/signup.html', {'form': form})

from .utils import verify_token

def verify_email(request, token):
    email = verify_token(token)
    if email:
        try:
            user = CreatorUser.objects.get(email=email)
            user.email_verified = True
            user.is_active = True
            user.save()
            messages.success(request, 'Email verified! You can now log in.')
            return redirect('login')
        except CreatorUser.DoesNotExist:
            messages.error(request, 'User not found.')
    else:
        messages.error(request, 'Invalid or expired token.')

    return redirect('creator_signup')

